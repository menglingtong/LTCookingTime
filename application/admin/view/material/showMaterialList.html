{include file="common/head" /}
<body>
	<div class="container-fluid">
		
		<div class="form-list">
			<div class="row">
				<div class="col-md-12">
					<div class="bs-callout bs-callout-danger">
						<h4>{$title}</h4>
						<p>查看、修改、搜索等操作</p>
					</div>
				</div>
			</div>

			<div class="row mainTop">
				<div class="col-xs-12 col-sm-6 btn-sespan">
					<div class="col-xs-12 col-sm-2">
                        <a href="{:url('addMaterial')}">
                            <button class="btn btn-xs btn-danger">
                                <i class="ace-icon fa fa-plus bigger-110"></i>
                                添加原料
                            </button>
                        </a>
                    </div>
					<form action="{:url('showMaterialList')}" class="form-search" role="from" id="materialSearch" method="POST">
						<div class="input-group">
							<span class="input-group-addon">
								<i class="ace-icon fa fa-search"></i>
							</span>
							<input type="text" name="searchName" id="searchName" class="form-control search-query admin_sea" value="" placeholder="请输入原料名称"/>
                            <span class="input-group-btn">
                                <button type="submit" class="btn btn-xs btm-input btn-purple">
                                    搜索
                                </button>
                            </span>
						</div>
					</form>
				</div>
			</div>
		
			<div class="row">
				<div class="col-md-12">
					<table class="table table-striped table-bordered table-hover center">
						<tr>
							<th>id</th>
							<th>名称</th>
							<th>价格</th>
							<th>近期价格</th>
							<th>单位</th>
							<th>类型</th>
							<th>库存</th>
							<th>厂商</th>
							<th>更新时间</th>
							<th>操作</th>
						</tr>
						{volist name="list" id="materialList"}
						<tr>
							<td>{$materialList.id}</td>
							<td>{$materialList.name}</td>
							<td>{$materialList.price}</td>
							<td>{$materialList.latest_price}</td>
							<td>{$materialList.unit}</td>
							<td>{$materialList.type}</td>
							<td>{$materialList.inventory}</td>
							<td>{$materialList.producer}</td>
							<td>{$materialList.update_time}</td>
							<td>
								<a href="#" 
								   class="btn btn-info btn-sm" 
								   data-toggle="modal" 
								   data-target="#editMaterial" 
								   onclick="return editMaterialFun({$materialList.id});">编辑</a>

								<!-- is_del 0:未停用  1：停用 -->
								{if condition="$materialList.is_del eq 0"}
								<a href="javascript:;" 
								   class="btn btn-danger btn-sm" 
								   onclick="return delMaterial({$materialList.id},{$materialList.is_del});">停用</a>
								{else /} 
								<a href="javascript:;" 
								   class="btn btn-warning btn-sm" 
								   onclick="return delMaterial({$materialList.id},{$materialList.is_del});">启用</a>
								{/if}
							</td>
						</tr>
						{/volist}
						<tr>
							<td colspan="10">&nbsp;</td>
						</tr>
					</table>
					
				</div>
			</div>
		</div>
	</div>
	
	<!-- 显示模态框::编辑分类 -->
	<div class="modal fade" id="editMaterial" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
		<form class="form-horizontal" name="editMaterial" id="editMaterial" method="POST" action="{:url('updateMaterial')}">
			<input type="hidden" name="editId" id="editId" value="" />
	        <div class="modal-dialog">
	            <div class="modal-content">
	                <div class="modal-header">
	                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
	                    <h4 class="modal-title">
	                        编辑原料信息
	                    </h4>
	                </div>
	                <div class="modal-body">
	                    <div class="row">
	                        <div class="col-xs-12">
	                        	<!-- 原料名称 -->
	                            <div class="form-group">
	                                <label class="col-sm-2 control-label no-padding-right" for="materialName">名称：</label>
	                                <div class="col-sm-10">
	                                    <input type="text" name="name" id="materialName" placeholder="原料名称" class="form-control col-xs-10 col-sm-5" />
	                                </div>
	                            </div>
	                            <!-- 市场价格 -->
	                            <div class="form-group">
	                                <label class="col-sm-2 control-label no-padding-right" for="materialPrice">价格：</label>
	                                <div class="col-sm-10">
	                                    <input type="text" name="price" id="materialPrice" placeholder="市场价格" class="form-control col-xs-10 col-sm-5" />
	                                </div>
	                            </div>
	                            <!-- 原料单位 -->
	                            <div class="form-group">
	                                <label class="col-sm-2 control-label no-padding-right" for="materialUnit">单位：</label>
	                                <div class="col-sm-10">
	                                    <input type="text" name="unit" id="materialUnit" placeholder="原料单位" class="form-control col-xs-10 col-sm-5" />
	                                </div>
	                            </div>
	                            <!-- 原料库存 -->
	                            <div class="form-group">
	                                <label class="col-sm-2 control-label no-padding-right" for="materialInventory">库存：</label>
	                                <div class="col-sm-10">
	                                    <input type="text" name="inventory" id="materialInventory" placeholder="库存数量" class="form-control col-xs-10 col-sm-5" />
	                                </div>
	                            </div>
	                            <!-- 原材料分类 -->
								<div class="form-group">
									<label class="col-sm-2 control-label no-padding-right" for="materialTypeSelect">类别：</label>
									<div class="col-sm-10">
										<input type="hidden" id="materialType" name="type" value="0">
										<select class="form-control" id="materialTypeSelect" onchange="selectChange();">
											<option value="0">请选择分类</option>
											{volist name = 'typeList' id = 'typeList'}
											<option id="{$typeList.id}" value="{$typeList.id}">{$typeList.name}</option>
											{/volist}
										</select>
									</div>
								</div>
								<!-- 生产厂商 -->
	                            <div class="form-group">
	                                <label class="col-sm-2 control-label no-padding-right" for="materialProducer">厂商：</label>
	                                <div class="col-sm-10">
	                                    <input type="text" name="producer" id="materialProducer" placeholder="生产商" class="form-control col-xs-10 col-sm-5" />
	                                </div>
	                            </div>
	                        </div>
	                    </div>
	                </div>
	                <div class="modal-footer">
	                    <button type="submit" class="btn btn-primary btn-sm" id="submit">提交保存</button>
	                    <button class="btn btn-info  btn-sm" type="reset">重置</button>
	                    <button type="button" class="btn btn-default  btn-sm" data-dismiss="modal" onclick="endEditMaterial();">关闭</button>
	                </div>
	            </div><!-- /.modal-content -->
	        </div><!-- /.modal-dialog -->
	    </form>
	</div>
	<!-- ./ 模态框 -->
	<script>

		jQuery(document).ready(function($) {
			
			$('#editMaterial').ajaxForm({

				beforeSubmit: checkForm,
				success: complete,
				dataForm: 'json',

			});


		});

		function checkForm() {
			// 验证原料名称是否为空
			if ($('#materialName').val() == '') {

				layer.alert('名称不能为空！', {icon: 2}, function (param) {
					layer.close(param);

					$('#materialName').focus();
				});

				return false;
			}

			// 验证原料价格是否为空
			if ($('#materialPrice').val() == '') {

				layer.alert('价格不能为空！', {icon: 2}, function (param) {
					layer.close(param);

					$('#materialPrice').focus();
				});

				return false;
			}

			// 验证价格是否为正确数字
			if (isNaN($('#materialPrice').val())) {

				layer.alert('请输入正确的数字！【价格】', {icon: 2}, function (param) {
					layer.close(param);

					$('#materialPrice').focus();
				});

				return false;
			}

			// 验证单位是否为空
			if ($('#materialUnit').val() == '') {

				layer.alert('单位不能为空！', {icon: 2}, function (param) {

					layer.close(param);

					$('#materialUnit').focus();
				});

				return false;
			}

			// 验证库存是否为空
			if ($('#materialInventory').val() == '') {

				layer.alert('库存不能为空！', {icon: 2}, function (param) {
					layer.close(param);

					$('#materialInventory').focus();
				});

				return false;
			}

			// 验证库存是否为正确数字
			if (isNaN($('#materialInventory').val())) {

				layer.alert('请输入正确的数字！【库存】', {icon: 2}, function (param) {
					layer.close(param);

					$('#materialInventory').focus();
				});

				return false;
			}

			var materialType = $('#materialType').val();

			console.log(materialType);
			// 验证分类是否选择正确
			if (materialType == '') {

				layer.alert('验证分类选择有误！', {icon: 2}, function (param) {
					
					layer.close(param);

				});

				return false;
			}

			if (materialType == 0) {

				layer.alert('验证分类选择有误！', {icon: 2}, function (param) {
					
					layer.close(param);

				});

				return false;
			}

			// 验证生产厂商是否为空
			if ($('#materialProducer').val() == '') {

				layer.alert('生产商不能为空！', {icon: 2}, function (param) {
					layer.close(param);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
					$('#materialProducer').focus();
				});

				return false;
			}

			console.log('前端验证结束');
		}

		function complete(data) {

			if (data.status == 1) {

				layer.msg(data.info, {icon: 1, time: 2000}, function (param) {
					
					layer.close(param);
					window.location.href = data.url;

				});

			}
			else
			{
				layer.msg(data.info, {icon: 2, time: 2000}, function (param) {
					
					layer.close(param);
					window.location.href = data.url;

				});
			}

		}

		// 停用按钮
		function delMaterial(id, isDel) {
			
			var str = "";

			if (isDel == 0) {
				str = "停用";
			} else {
				str = "启用";
			}

			layer.confirm("您确定要"+str+"吗？", {icon: 3}, function (index) {
				
				layer.close(index);

				$.get("{:url('delMaterial')}?id=" + id + "&isDel=" + isDel, function(data) {
					
					if (data.status == 1) {

						layer.msg(data.info, {icon: 6, time: 1000}, function (argument) {
							
							layer.close(argument);

							window.location.href = data.url;
						});

					} else {

						layer.msg(data.info, {icon: 5, time: 1000}, function (argument) {
							
							layer.close(argument);

							window.location.href = data.url;
						});
					}

				});

			});

		}

		// 编辑按钮
		function editMaterialFun(id) {
			
			$.get("{:url('readMaterialById')}?materialId=" + id, function(data) {
				// 查询成功
				if (data.status == 1) {

					var materialObj = data.obj;

					$('#materialName').val(materialObj.name);
					$('#materialPrice').val(materialObj.price);
					$('#materialUnit').val(materialObj.unit);
					$('#materialInventory').val(materialObj.inventory);
					$('#materialProducer').val(materialObj.producer);
					$('#editId').val(materialObj.id);

					var options = $('#materialTypeSelect option');

					$.each(options, function(index, val) {
						 
						 if (val.text == materialObj.type) {
						 	console.log(val.text);
						 	$(this).attr('selected', 'selected');

						 }
					});

					$('#materialType').val(materialObj.type);

				} else {

					layer.alert(data.info, {icon: 3}, function (argument) {
						layer.close(argument);
					});
				}

			});

		}

		// select触发方法
		function selectChange() {
				
			var objSelect = $('#materialTypeSelect');

			// $('#materialType').val(objSelect.val());
			$('#materialType').val(objSelect.find("option:selected").text());

		}

		// 结束编辑
		function endEditMaterial() {
			
			var objSelect = $('#materialTypeSelect');

			objSelect.find("option:selected").removeAttr('selected');

		}
		
	</script>
</body>
</html>